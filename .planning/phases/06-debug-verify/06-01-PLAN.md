---
phase: 06-debug-verify
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Gmail tools (list_messages, read_message, etc.) appear in MCP client"
    - "list_messages returns recent emails without errors"
    - "Token refresh works when token is expired"
  artifacts:
    - path: "/Users/alvin/dev/n8n_builder/.mcp.json"
      provides: "MCP server configuration"
      contains: "gmail-lhc"
    - path: "~/.gmail-mcp/lhc/credentials.json"
      provides: "OAuth credentials with refresh token"
      contains: "refresh_token"
  key_links:
    - from: ".mcp.json gmail-lhc config"
      to: "/Users/alvin/dev/mcp_servers/gmail-mcp/dist/index.js"
      via: "node command with absolute path"
      pattern: "dist/index.js"
---

<objective>
Debug and verify Gmail MCP server works in the MCP client environment

Purpose: The server works when tested directly (confirmed via manual MCP protocol tests), but user reports it's not working after MCP client restart. Need to identify the issue and verify the fix.

Output: Working Gmail MCP server with tools visible in MCP client
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@/Users/alvin/dev/n8n_builder/.mcp.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnose server loading issue</name>
  <files>N/A - diagnostic only</files>
  <action>
Run diagnostic checks to understand why server might not load in MCP client:

1. Verify dist/index.js exists and is executable:
   ```bash
   ls -la /Users/alvin/dev/mcp_servers/gmail-mcp/dist/index.js
   head -1 /Users/alvin/dev/mcp_servers/gmail-mcp/dist/index.js
   ```

2. Check node can run the entry point:
   ```bash
   GMAIL_CREDENTIALS_PATH=~/.gmail-mcp/lhc/credentials.json node /Users/alvin/dev/mcp_servers/gmail-mcp/dist/index.js &
   sleep 2
   # Look for "Gmail MCP server running on stdio" in stderr
   # Kill the process after
   ```

3. Check .mcp.json configuration syntax:
   - Verify JSON is valid
   - Verify paths are absolute (no ~)
   - Verify command is "node" not "npx"

4. Check credentials exist and have refresh_token:
   ```bash
   cat ~/.gmail-mcp/lhc/credentials.json | grep refresh_token
   cat ~/.gmail-mcp/personal/credentials.json | grep refresh_token
   ```

5. Check OAuth keys file exists:
   ```bash
   cat ~/.gmail-mcp/gcp-oauth.keys.json | head -5
   ```

Record findings with status for each check:
- PASS: dist/index.js exists and starts
- PASS/FAIL: .mcp.json syntax valid
- PASS/FAIL: credentials have refresh_token
- PASS/FAIL: OAuth keys file exists

Produce a diagnostic summary: "All checks PASS" or "Failed checks: [list]"
  </action>
  <verify>All 5 diagnostic checks completed with PASS/FAIL status recorded</verify>
  <done>Diagnostic summary produced: either "All checks PASS" or "Failed checks: X, Y, Z"</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Diagnostic checks to identify the server loading issue</what-built>
  <how-to-verify>
1. Based on diagnostics, restart your MCP client and test:
   - Restart your MCP client (OpenCode or whatever you're using)
   - Check if Gmail tools appear in the tools list
   - Try running `list_messages` with maxResults: 3

2. Report back with one of these outcomes:

   **Outcome A - Everything works:**
   "tools visible: yes, list_messages works: yes"

   **Outcome B - Tools don't appear:**
   "tools visible: no" + any error messages from MCP client logs

   **Outcome C - Tools appear but fail:**
   "tools visible: yes, list_messages works: no" + the error message

3. **Test token refresh** (required for VER-03):
   - Open ~/.gmail-mcp/lhc/credentials.json
   - Change the `expiry_date` to a past timestamp (e.g., `1700000000000`)
   - Save the file
   - Run `list_messages` again with maxResults: 1
   - It should work without asking you to re-authenticate
   - Report: "token refresh: yes" (worked) or "token refresh: no" (failed/asked for re-auth)
  </how-to-verify>
  <resume-signal>Report outcome: A/B/C with details, AND "token refresh: yes/no"</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Confirm working or apply fix</name>
  <files>Depends on outcome - may be none, may be /Users/alvin/dev/n8n_builder/.mcp.json</files>
  <action>
Based on checkpoint outcome:

**Outcome A (Everything works):**
- No code changes needed
- Document in summary: "Server confirmed working. Diagnostics passed, user verified tools load and function correctly."

**Outcome B (Tools don't appear):**
Apply these fixes in order until resolved:
1. Expand ~ to absolute path in .mcp.json GMAIL_CREDENTIALS_PATH
2. Add GMAIL_OAUTH_KEYS_PATH=/Users/alvin/.gmail-mcp/gcp-oauth.keys.json to env if missing
3. Verify node path is /usr/local/bin/node or correct system path

**Outcome C (Tools appear but list_messages fails):**
Check the specific error and apply:
- "OAuth keys file not found" -> Add GMAIL_OAUTH_KEYS_PATH env var
- "Invalid credentials" -> Re-run authenticate command
- "Token refresh failed" -> Check refresh_token exists, re-authenticate if needed

**Token refresh failed:**
If user reported "token refresh: no":
- Check that refresh_token exists in credentials.json
- Verify GMAIL_OAUTH_KEYS_PATH is set (needed for refresh)
- If refresh_token missing, user needs to re-authenticate
  </action>
  <verify>
- Outcome A: No verification needed (already confirmed by user)
- Outcome B/C: After fix, run `cat /Users/alvin/dev/n8n_builder/.mcp.json` to show updated config, then user re-tests
- Token refresh: User confirmed "token refresh: yes" during checkpoint
  </verify>
  <done>
- Outcome A: Summary states "Server working, no fixes needed"
- Outcome B/C: .mcp.json updated AND user confirms tools now work
- Token refresh verified: User confirmed automatic token refresh works
  </done>
</task>

</tasks>

<verification>
- Server process starts without immediate crash
- MCP protocol handshake succeeds (initialize -> initialized -> tools/list)
- tools/list returns 9 Gmail tools
- tools/call list_messages returns email data without auth errors
- Token refresh works when access token is expired (VER-03)
</verification>

<success_criteria>
1. Gmail tools (9 total) appear in MCP client after restart
2. list_messages successfully returns recent emails
3. No auth errors during tool execution
4. Token refresh works automatically when access token is expired
</success_criteria>

<output>
After completion, create `.planning/phases/06-debug-verify/06-01-SUMMARY.md`
</output>
