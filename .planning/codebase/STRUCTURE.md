# Codebase Structure

**Analysis Date:** 2026-01-27

## Directory Layout

```
gmail-mcp/
├── src/                     # TypeScript source code
│   ├── index.ts            # MCP server entry point, tool definitions, request handling
│   ├── tools.ts            # Gmail API tool implementations
│   ├── oauth.ts            # OAuth2 client, credential management, token refresh
│   └── auth.ts             # OAuth2 authentication flow, credential saving
├── dist/                   # Compiled JavaScript (generated by tsc)
├── package.json            # Project metadata, dependencies, scripts
├── tsconfig.json           # TypeScript compiler configuration
├── README.md               # User documentation
└── .planning/              # GSD planning documents
    └── codebase/           # Analysis documents (this directory)
```

## Directory Purposes

**src/:**
- Purpose: All TypeScript source files
- Contains: MCP server implementation, Gmail API integration, OAuth2 logic
- Key files: `index.ts` (server), `tools.ts` (Gmail operations), `oauth.ts` (auth)

**dist/:**
- Purpose: Compiled JavaScript output
- Contains: Generated .js and .d.ts files (one for each src/*.ts)
- Generated: Yes (by `tsc`)
- Committed: No (in .gitignore)

**.planning/codebase/:**
- Purpose: Architecture and codebase analysis documents
- Contains: ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, etc.
- Generated: No (manually created by GSD mapping)
- Committed: Yes

## Key File Locations

**Entry Points:**
- `src/index.ts`: Main MCP server, exports stdio server on startup
- `src/auth.ts`: Authentication script, handles OAuth2 flow

**Configuration:**
- `package.json`: Dependencies (MCP SDK, googleapis), scripts, metadata
- `tsconfig.json`: Compiler options (ES2022 target, strict mode, NodeNext module resolution)

**Core Logic:**
- `src/tools.ts`: All Gmail API operations (list/read/search/send messages, labels, drafts)
- `src/oauth.ts`: OAuth2 client initialization, credential persistence, token refresh

**Compiled Output:**
- `dist/index.js`: Compiled MCP server
- `dist/tools.js`: Compiled tool implementations
- `dist/oauth.js`: Compiled OAuth module
- `dist/auth.js`: Compiled auth script

## Naming Conventions

**Files:**
- Kebab-case for config: `tsconfig.json`, `package-lock.json`
- Camel-case for source: `index.ts`, `tools.ts`, `oauth.ts`, `auth.ts`
- UPPERCASE for docs: `README.md`, `ARCHITECTURE.md`, `STRUCTURE.md`

**Directories:**
- Lowercase plural for source code: `src/`
- Lowercase plural for output: `dist/`
- Hidden directories with dot prefix: `.git/`, `.planning/`

**Functions:**
- Camel-case: `getGmailClient()`, `listMessages()`, `refreshAccessToken()`
- Export public functions without underscore prefix
- Helper functions (lowercase): `decodeBase64Url()`, `extractBody()`, `getHeader()`

**Types/Interfaces:**
- PascalCase: `Credentials`, `OAuthKeys`, `Gmail`
- Union/generic types: Use for Gmail API types from `googleapis` library

**Constants:**
- UPPERCASE with underscores: `SCOPES`, `PORT`

## Where to Add New Code

**New Gmail Tool (e.g., archive_message):**
- Signature: Add export function to `src/tools.ts`
  - Pattern: Match existing tool signatures (params object, return typed promise)
  - Example: `export async function archiveMessage(params: { messageId: string }): Promise<{ id: string }>`
- Integration: Add tool object to `tools` array in `src/index.ts`
  - Include: name, description, inputSchema properties
- Routing: Add case in CallToolRequestSchema handler switch statement
  - Pattern: `case "archive_message": result = await archiveMessage(args as Parameters<typeof archiveMessage>[0]); break;`

**New OAuth/Credential Feature:**
- Location: `src/oauth.ts`
- Pattern: Add new export functions (e.g., `clearCredentials()`, `getCredentialExpiry()`)
- Requirements: Always read from disk, never cache in memory
- Testing: Verify with `src/auth.ts` if it affects auth flow

**Utility Function:**
- For message parsing: Add to `src/tools.ts` near other parsing functions (decodeBase64Url, extractBody, getHeader)
- For credential handling: Add to `src/oauth.ts` with existing loader functions
- Scope: Keep helpers in same file as consumers

## Special Directories

**node_modules/:**
- Purpose: Installed npm packages
- Generated: Yes (`npm install`)
- Committed: No (excluded by .gitignore)

**dist/:**
- Purpose: Compiled JavaScript and type definitions
- Generated: Yes (`npm run build`)
- Committed: No (excluded by .gitignore)

## Build and Compilation

**Compilation:**
- Command: `npm run build` or `tsc`
- Input: `src/**/*.ts`
- Output: `dist/` with matching structure
- Settings: `src/` as rootDir, `dist/` as outDir, ES2022 target, NodeNext modules

**Watch Mode:**
- Command: `npm run dev`
- Auto-recompiles on file changes

**Generated Files:**
- `dist/*.js`: Compiled JavaScript modules
- `dist/*.d.ts`: TypeScript type definitions
- All .js files have shebang (`#!/usr/bin/env node`) if executable

## Script Entry Points

**Available npm scripts:**
- `npm run build`: Compile TypeScript to JavaScript
- `npm run dev`: Watch mode for development
- `npm start`: Run compiled MCP server
- `npm run auth`: Run authentication flow
