---
phase: 06-debug-verify
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Gmail tools (list_messages, read_message, etc.) appear in MCP client"
    - "list_messages returns recent emails without errors"
    - "Token refresh works when token is expired"
  artifacts:
    - path: "/Users/alvin/dev/n8n_builder/.mcp.json"
      provides: "MCP server configuration"
      contains: "gmail-lhc"
    - path: "~/.gmail-mcp/lhc/credentials.json"
      provides: "OAuth credentials with refresh token"
      contains: "refresh_token"
  key_links:
    - from: ".mcp.json gmail-lhc config"
      to: "/Users/alvin/dev/mcp_servers/gmail-mcp/dist/index.js"
      via: "node command with absolute path"
      pattern: "dist/index.js"
---

<objective>
Debug and verify Gmail MCP server works in the MCP client environment

Purpose: The server works when tested directly (confirmed via manual MCP protocol tests), but user reports it's not working after MCP client restart. Need to identify the issue and verify the fix.

Output: Working Gmail MCP server with tools visible in MCP client
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@/Users/alvin/dev/n8n_builder/.mcp.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnose server loading issue</name>
  <files>N/A - diagnostic only</files>
  <action>
Run diagnostic checks to understand why server might not load in MCP client:

1. Verify dist/index.js exists and is executable:
   ```bash
   ls -la /Users/alvin/dev/mcp_servers/gmail-mcp/dist/index.js
   head -1 /Users/alvin/dev/mcp_servers/gmail-mcp/dist/index.js
   ```

2. Check node can run the entry point:
   ```bash
   GMAIL_CREDENTIALS_PATH=~/.gmail-mcp/lhc/credentials.json node /Users/alvin/dev/mcp_servers/gmail-mcp/dist/index.js &
   sleep 2
   # Look for "Gmail MCP server running on stdio" in stderr
   # Kill the process after
   ```

3. Check .mcp.json configuration syntax:
   - Verify JSON is valid
   - Verify paths are absolute (no ~)
   - Verify command is "node" not "npx"

4. Check credentials exist and have refresh_token:
   ```bash
   cat ~/.gmail-mcp/lhc/credentials.json | grep refresh_token
   cat ~/.gmail-mcp/personal/credentials.json | grep refresh_token
   ```

5. Check OAuth keys file exists:
   ```bash
   cat ~/.gmail-mcp/gcp-oauth.keys.json | head -5
   ```

Record findings: what works, what fails, what the actual error is.
  </action>
  <verify>Diagnostic complete with clear findings documented</verify>
  <done>Root cause identified or server confirmed working</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Diagnostic checks to identify the server loading issue</what-built>
  <how-to-verify>
1. Based on diagnostics, if server is confirmed working:
   - Restart your MCP client (OpenCode or whatever you're using)
   - Check if Gmail tools appear in the tools list
   - Try running `list_messages` with maxResults: 3

2. If tools don't appear, check MCP client logs for errors:
   - Look for startup errors from gmail-lhc or gmail-personal
   - Check if the process even starts

3. Report back:
   - Do Gmail tools appear after restart? (yes/no)
   - Can you successfully call list_messages? (yes/no)
   - Any error messages you see?
  </how-to-verify>
  <resume-signal>Report: tools visible (yes/no), list_messages works (yes/no), any errors</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Fix identified issues (if any)</name>
  <files>Depends on diagnosis</files>
  <action>
Based on checkpoint feedback, apply fixes:

**If tools don't appear (server not loading):**
- Check MCP client config file location is correct
- Ensure absolute paths in .mcp.json (no ~ expansion issues)
- Verify node path is correct

**If tools appear but list_messages fails:**
- Check error message for auth issues
- Verify credentials.json has valid tokens
- Check if expiry_date is in the past and refresh is failing

**If "OAuth keys file not found" error:**
- The server expects GMAIL_OAUTH_KEYS_PATH env var OR default ~/.gmail-mcp/gcp-oauth.keys.json
- Add GMAIL_OAUTH_KEYS_PATH to .mcp.json env section if needed

**If "command not found: timeout" or similar:**
- This is a macOS compatibility issue (timeout is GNU coreutils)
- Not relevant to MCP server operation

Document what was fixed.
  </action>
  <verify>Re-run diagnostic checks to confirm fix applied</verify>
  <done>Issue resolved or escalated with clear next steps</done>
</task>

</tasks>

<verification>
- Server process starts without immediate crash
- MCP protocol handshake succeeds (initialize -> initialized -> tools/list)
- tools/list returns 9 Gmail tools
- tools/call list_messages returns email data without auth errors
</verification>

<success_criteria>
1. Gmail tools (9 total) appear in MCP client after restart
2. list_messages successfully returns recent emails
3. No auth errors during tool execution
</success_criteria>

<output>
After completion, create `.planning/phases/06-debug-verify/06-01-SUMMARY.md`
</output>
